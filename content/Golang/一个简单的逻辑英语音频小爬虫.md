---
title: "ä¸€ä¸ªç®€å•çš„é€»è¾‘è‹±è¯­éŸ³é¢‘å°çˆ¬è™«"
date: 2018-12-05T21:41:32+08:00
tags: ["Spider"]
categories: ["Golang"]
description : "ä¸€ä¸ªç®€å•çš„é€»è¾‘è‹±è¯­éŸ³é¢‘å°çˆ¬è™«"
draft: false
---
<!-- TOC -->

- [1. ç½‘é¡µåˆ†æ](#1-%E7%BD%91%E9%A1%B5%E5%88%86%E6%9E%90)
- [2. ä»£ç ç¼–å†™](#2-%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99)

<!-- /TOC -->

æœ€è¿‘åœ¨çœ‹é€»è¾‘è‹±è¯­çš„è¯¾ç¨‹ï¼Œæ„Ÿè§‰è¿˜æŒºä¸é”™çš„ï¼Œä¸è¿‡çœ‹å®Œè§†é¢‘å¥½åƒå•¥ä¹Ÿæ²¡è®°ä½ğŸ˜¥ï¼Œæ­£å¥½çœ‹è§æœ‰é€»è¾‘è‹±è¯­çš„çº¸è´¨ä¹¦å°±ä¹°äº†ä¸€æœ¬æ²¡äº‹å¯ä»¥ç¿»ç¿»ï¼Œè¿™æœ¬ä¹¦éšä¹¦èµ é€äº†ä¸€äº›é…å¥—çš„éŸ³é¢‘ï¼Œä½†æ˜¯éƒ½æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„åˆ†å¼€åœ¨å¾®ä¿¡å…¬ä¼—å·æ–‡ç« å†…çš„ï¼Œæƒ³è¦ä¸‹è½½ä¸‹æ¥å¬æ¯”è¾ƒæ–¹ä¾¿ä¸€äº›ï¼Œæ‰€ä»¥ç ”ç©¶äº†ä¸€ä¸‹ï¼ŒèŠ±äº†åå‡ åˆ†é’Ÿå†™äº†ä¸ªå°çˆ¬è™«ï¼Œè¶ç€æœ‰ç©ºå†™ç¯‡åšå®¢è®°å½•ä¸€ä¸‹ã€‚

# 1. ç½‘é¡µåˆ†æ

é¦–å…ˆæˆ‘ä»¬æ‰“å¼€éŸ³é¢‘çš„[æ±‡æ€»é¡µé¢](http://c.youdao.com/xue/activity/ljyyyf_zzfw2.html)ï¼Œçœ‹ä¸€ä¸‹è¿™ä¸ªé¡µé¢çš„HTMLç»“æ„ã€‚
![æ±‡æ€»é¡µ](/image/Snipaste_2018-12-05_21-55-28.png)
å¯ä»¥çœ‹åˆ°æ¯ä¸€ä¸ªéŸ³é¢‘éƒ½æŒ‡å‘ä¸€ä¸ªå…¬ä¼—å·å›¾æ–‡ç½‘é¡µï¼Œåªéœ€è¦è·å–è¿™äº›`href`çš„é“¾æ¥å°±å¯ä»¥è¿›å»éŸ³é¢‘çš„é¡µé¢äº†ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬è¿›å…¥å›¾æ–‡é¡µé¢ï¼Œçœ‹çœ‹æ€ä¹ˆè·å–éŸ³é¢‘æ–‡ä»¶ã€‚
![éŸ³é¢‘é¡µ](/image/Snipaste_2018-12-05_21-58-19.png)

åœ¨éŸ³é¢‘é¡µé¢æ‰¾äº†ä¸€ä¸‹ï¼Œæ²¡æœ‰å‘ç°æœ‰éŸ³é¢‘æ–‡ä»¶çš„ï¼Œä¹Ÿæ²¡æœ‰æ‰¾åˆ°`<audio>`æ ‡ç­¾ï¼Œä½†æ˜¯å‘ç°æœ‰ä¸€ä¸ªä¸è®¤è¯†çš„æ ‡ç­¾`mpvoice`ï¼Œçœ‹èµ·æ¥åƒæ˜¯å¾®ä¿¡è‡ªå·±å¼„çš„ä¸€ä¸ªæ ‡ç­¾ï¼Œçœ‹æ¥ä»é¡µé¢ä¸Šä¸èƒ½ç›´æ¥è·å–éŸ³é¢‘æ–‡ä»¶äº†ã€‚

å…ˆä¸ç®¡HTMLä»£ç äº†ï¼Œç‚¹å‡»æ’­æ”¾æŒ‰é’®çœ‹ä¸€ä¸‹æ˜¯æ€ä¹ˆæ’­æ”¾çš„ã€‚

æ²¡æœ‰å‘ç°ä»€ä¹ˆæœ‰ä»·å€¼çš„ä¸œè¥¿ï¼Œå…ˆæ”¾å¼ƒåˆ†æHTMLäº†ï¼Œçœ‹çœ‹Networkä¸­æœ‰ä»€ä¹ˆæœ‰ç”¨çš„ä¸œè¥¿ï¼Œç‚¹å®Œä¹‹åæœç„¶æœ‰æ”¶è·ã€‚
![éŸ³é¢‘](/image/Snipaste_2018-12-05_22-05-54.png)

çœ‹è¿™ä¸ªæ¥å£å¤§æ¦‚å°±å¯ä»¥çŒœåˆ°æ˜¯è·å–éŸ³é¢‘çš„ï¼Œå¤åˆ¶é“¾æ¥åœ¨æ–°çª—å£æ‰“å¼€ï¼ŒæœçœŸæ˜¯éŸ³é¢‘æ–‡ä»¶ã€‚åœ¨æ‰“å¼€å‡ ä¸ªéŸ³é¢‘å›¾æ–‡ï¼Œå¯ä»¥å‘ç°æ¯ä¸ªéŸ³é¢‘è°ƒç”¨çš„éƒ½æ˜¯ç›¸åŒçš„æ¥å£ï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯æŸ¥è¯¢å‚æ•°`mediaid`çš„å€¼ä¸åŒï¼Œç”±æ­¤å¯ä»¥çŸ¥é“å¾®ä¿¡å›¾æ–‡è·å–éŸ³é¢‘æ˜¯è°ƒç”¨è¯¥æ¥å£ï¼Œå¸¦ä¸ŠéŸ³é¢‘çš„ä¸€ä¸ª`id`å°±å¯ä»¥è·å–ã€‚  

æ¥ä¸‹æ¥å°±æ˜¯æ‰¾æ‰¾`mediaid`åœ¨å“ªé‡Œäº†ï¼Œæ‰“å¼€HTMLä»£ç ï¼Œå¾ˆå®¹æ˜“å°±å‘ç°äº†åœ¨`<mpvoice>`æ ‡ç­¾ä¸Šæœ‰ä¸€ä¸ª`voice_encode_fileid`å±æ€§çš„å€¼å°±æ˜¯`mediaid`çš„å€¼ã€‚

åˆ†æå®Œäº†é¡µé¢çš„ç»“æ„ï¼Œæ¥ä¸‹æ¥å°±å¾ˆå®¹æ˜“å†™ä»£ç äº†ã€‚

# 2. ä»£ç ç¼–å†™

ä½¿ç”¨Goè¯­è¨€å†™ç®€å•çš„çˆ¬è™«å¾ˆç®€å•ï¼Œå…ˆè¯´å‡ ä¸ªå…³é”®ç‚¹ï¼Œç„¶åè´´å®Œæ•´çš„ä»£ç ã€‚

ä»£ç ä½¿ç”¨äº†`github.com/PuerkitoBio/goquery`è¿™ä¸ªåº“è§£æHTMLç»“æ„çš„ï¼Œå¦‚æœä½ ç†Ÿæ‚‰`JQuery`çš„ä½¿ç”¨ï¼Œé‚£ä¹ˆå¯ä»¥å¾ˆå®¹æ˜“çš„ä½¿ç”¨è¿™ä¸ªåº“è§£æHTMLè·å–æœ‰ç”¨çš„æ•°æ®ã€‚

```golang
// åˆ›å»ºéŸ³é¢‘æ±‡æ€»åˆ—è¡¨çš„DOMè¯»å–å™¨
doc, docErr := goquery.NewDocumentFromReader(strings.NewReader(res))
if docErr!=nil {
    log.Fatalf("%v",docErr)
}
```

- é¦–å…ˆä½¿ç”¨`NewDocumentFromReader`å‡½æ•°å°†è·å–çš„é¡µé¢HTMLå­—ç¬¦ä¸²ï¼Œè½¬æ¢æˆ`goquery`ä¸­çš„`Document`ç»“æ„ï¼Œ`Document`ä¸­åŒ…å«çš„`Node`å¯ä»¥ç”±é€‰æ‹©å™¨è¯­æ³•è¿›è¡Œè§£æã€‚

```golang
// è¯»å–åˆ—è¡¨ä¸­çš„æ¯ä¸€ä¸ªéŸ³é¢‘é“¾æ¥
doc.Find("section a").Each(func(i int,s *goquery.Selection){
    mp3Url:=s.AttrOr("href","")
    log.Printf("%v",mp3Url)
})
```

- ä½¿ç”¨`Find`å‡½æ•°è·å–HTMLä¸­çš„æŒ‡å®šNodeï¼ŒæŒ‡å®šçš„æ–¹å¼æ˜¯è·Ÿä½¿ç”¨Jqueryä¸€æ ·çš„ï¼Œä¾‹å¦‚è¿™é‡Œæˆ‘ä»¬æŸ¥æ‰¾`section`æ ‡ç­¾ä¸‹çš„`a`æ ‡ç­¾ã€‚
- ç”±äº`a`æ ‡ç­¾æ˜¯æœ‰å¾ˆå¤šä¸ªçš„ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨`Each`å‡½æ•°å¤„ç†æ¯ä¸€ä¸ªèŠ‚ç‚¹ã€‚
- ç„¶ååœ¨å¾ªç¯ä¸­ï¼Œè·å–æ¯ä¸€ä¸ª`a`æ ‡ç­¾çš„`href`å±æ€§çš„å€¼ã€‚è·å–èŠ‚ç‚¹å±æ€§çš„å€¼æœ‰ä¸¤ä¸ªæ–¹æ³•:
    - `AttrOr("","")`ï¼šç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å±æ€§çš„åå­—ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ²¡æœ‰æ‰¾åˆ°æŒ‡å®šçš„å±æ€§æ—¶ï¼Œé»˜è®¤è¿”å›çš„å€¼ã€‚
    - `Attr("")`ï¼šè¿™ä¸ªæ–¹æ³•å¦‚æœæ²¡æœ‰æ‰¾åˆ°æŒ‡å®šçš„å±æ€§ï¼Œå°±ä¼šè¿”å›`string`å’Œ`bool`ç±»å‹çš„é›¶å€¼ï¼Œå¦åˆ™å°±è¿”å›æŒ‡å®šå±æ€§çš„å€¼å’Œtrueã€‚

å®Œæ•´çš„ä»£ç ï¼š

```golang
package main

import (
	"os"
	"io"
	"log"
	"strings"
	"net/http"
	"io/ioutil"
	"github.com/PuerkitoBio/goquery"
)

func main(){
	defer func ()  {
		if panicErr := recover(); panicErr != nil {
			log.Fatalf("ç¨‹åºå‘ç”Ÿå¼‚å¸¸ï¼Œå¼‚å¸¸ä¿¡æ¯ï¼š%v",panicErr)
		}
	}()

	res:=GetMethod("http://c.youdao.com/xue/activity/ljyyyf_zzfw2.html")

	if res != "" {
		// åˆ›å»ºéŸ³é¢‘æ±‡æ€»åˆ—è¡¨çš„DOMè¯»å–å™¨
		doc, docErr := goquery.NewDocumentFromReader(strings.NewReader(res))
		if docErr!=nil {
			log.Fatalf("%v",docErr)
		}
		// è¯»å–åˆ—è¡¨ä¸­çš„æ¯ä¸€ä¸ªéŸ³é¢‘é“¾æ¥
		doc.Find("section a").Each(func(i int,s *goquery.Selection){
			mp3Url:=s.AttrOr("href","")
			log.Printf("%v",mp3Url)
			res=GetMethod(mp3Url)

			// åˆ›å»ºå›¾æ–‡å†…å®¹çš„DOMè¯»å–å™¨
			docAudio, docAudioErr := goquery.NewDocumentFromReader(strings.NewReader(res))
			if docAudioErr!=nil {
				log.Fatalf("%v",docErr)
			}
			content:=docAudio.Find("div#img-content")
			// è§£ææ ‡é¢˜ä½œä¸ºéŸ³é¢‘çš„åç§°
			title:=strings.TrimSpace(content.Find("h2.rich_media_title").Text())
			// è·å–éŸ³é¢‘çš„æ ‡è¯†
			mediaid:=strings.TrimSpace(content.Find("mpvoice").AttrOr("voice_encode_fileid",""))
			log.Printf("%s:%s",title,mediaid)
			// ä¸‹è½½æ–‡ä»¶
			err := DownloadFile(title+".mp3", "https://res.wx.qq.com/voice/getvoice?mediaid="+mediaid)
			if err != nil {
				log.Fatalf("%v",err)
			}
		})
	}
}

// è·å–GETè¯·æ±‚é¡µé¢å†…å®¹
func GetMethod(getUrl string)string{
	client := &http.Client{}

	request, err := http.NewRequest("GET", getUrl, nil)
	if err!=nil {
		log.Printf("å‘é€GETè¯·æ±‚å‘ç”Ÿé”™è¯¯ï¼Œé”™è¯¯ä¿¡æ¯ï¼š%v",err)
	}

	response, errRes := client.Do(request)
	if errRes!=nil {
		log.Printf("è·å–å“åº”GETè¯·æ±‚å‘ç”Ÿé”™è¯¯ï¼Œé”™è¯¯ä¿¡æ¯ï¼š%v",errRes)
	}
	defer response.Body.Close()
	if response.StatusCode == 200 {
		str, _ := ioutil.ReadAll(response.Body)
		bodyStr := string(str)
		return bodyStr
	}
	return ""
}

// ä¸‹è½½æ–‡ä»¶
func DownloadFile(filepath string, dUrl string) error {

	out, err := os.Create(filepath)
	if err != nil {
		return err
	}
	defer out.Close()

	resp, err := http.Get(dUrl)
	if err != nil {
		return err
	}
	defer resp.Body.Close()

	_, err = io.Copy(out, resp.Body)
	if err != nil {
		return err
	}
	log.Printf("%v ----- ä¸‹è½½å®Œæˆï¼",filepath)
	return nil
}
```